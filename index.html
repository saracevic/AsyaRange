<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asya Range Tarayƒ±cƒ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .debug-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .debug-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .debug-toggle h2 {
            color: #667eea;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debug-toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .debug-toggle-icon.open {
            transform: rotate(90deg);
        }

        .debug-content {
            margin-top: 20px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .debug-content.visible {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .debug-info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .debug-info-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .debug-info-line {
            padding: 5px 0;
            color: #333;
            font-size: 14px;
        }

        .debug-info-line strong {
            color: #764ba2;
            display: inline-block;
            min-width: 180px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-card .stat-value {
            color: #667eea;
            font-size: 1.8em;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .distance {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .distance-green {
            background: #d4edda;
            color: #155724;
        }

        .distance-yellow {
            background: #fff3cd;
            color: #856404;
        }

        .distance-orange {
            background: #ffe5cc;
            color: #cc5200;
        }

        .distance-red {
            background: #f8d7da;
            color: #721c24;
        }

        .price {
            font-family: 'Courier New', monospace;
            color: #333;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 10px;
            }

            .stat-card .stat-value {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Asya Range Tarayƒ±cƒ±</h1>
            <p class="subtitle">Son Cuma Asya seansƒ± Fib50 seviyeleri tarayƒ±cƒ±sƒ±</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="tolerance">Tolerans Seviyesi (%)</label>
                <input type="number" id="tolerance" value="1" min="0" max="100" step="0.1">
            </div>
            <button id="scanBtn" onclick="scanMarkets()">Taramayƒ± Ba≈ülat</button>
        </div>

        <div id="debugSection" class="debug-section" style="display: none;">
            <div class="debug-toggle" onclick="toggleDebug()">
                <h2>üîç Debug Bilgileri</h2>
                <span class="debug-toggle-icon" id="debugIcon">‚ñ∂</span>
            </div>
            <div class="debug-content" id="debugContent">
                <div class="debug-info-box">
                    <h3>üìÖ Taranan Asya Seansƒ±</h3>
                    <div class="debug-info-line"><strong>Tarih:</strong> <span id="debugDate"></span></div>
                    <div class="debug-info-line"><strong>‚è∞ Ba≈ülangƒ±√ß:</strong> <span id="debugStartTime"></span></div>
                    <div class="debug-info-line"><strong>‚è∞ Biti≈ü:</strong> <span id="debugEndTime"></span></div>
                </div>

                <div class="debug-info-box">
                    <h3>üìä BTC/USDT Detaylƒ± Analiz</h3>
                    <div class="debug-info-line"><strong>Asya Seansƒ± Mum Sayƒ±sƒ±:</strong> <span id="debugCandleCount"></span></div>
                    <div class="debug-info-line"><strong>WickHigh:</strong> $<span id="debugWickHigh"></span></div>
                    <div class="debug-info-line"><strong>WickLow:</strong> $<span id="debugWickLow"></span></div>
                    <div class="debug-info-line"><strong>Fib50:</strong> $<span id="debugFib50"></span></div>
                    <div class="debug-info-line"><strong>G√ºncel Fiyat:</strong> $<span id="debugCurrentPrice"></span></div>
                    <div class="debug-info-line"><strong>Mesafe:</strong> <span id="debugDistance"></span>%</div>
                </div>

                <div class="debug-info-box">
                    <h3>üìà Tarama ƒ∞statistikleri</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Toplam Taranan</div>
                            <div class="stat-value" id="statTotal">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">%1 ƒ∞√ßinde</div>
                            <div class="stat-value" id="stat1">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">%2 ƒ∞√ßinde</div>
                            <div class="stat-value" id="stat2">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">%5 ƒ∞√ßinde</div>
                            <div class="stat-value" id="stat5">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">%10 ƒ∞√ßinde</div>
                            <div class="stat-value" id="stat10">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Piyasalar taranƒ±yor...</p>
        </div>

        <div id="results" class="results" style="display: none;">
            <h2>Tarama Sonu√ßlarƒ±</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        let debugData = {
            btc: {},
            stats: {
                total: 0,
                within1: 0,
                within2: 0,
                within5: 0,
                within10: 0
            }
        };

        function toggleDebug() {
            const content = document.getElementById('debugContent');
            const icon = document.getElementById('debugIcon');
            
            if (content.classList.contains('visible')) {
                content.classList.remove('visible');
                icon.classList.remove('open');
            } else {
                content.classList.add('visible');
                icon.classList.add('open');
            }
        }

        function updateDebugPanel() {
            document.getElementById('debugSection').style.display = 'block';
            
            // Date and time info
            const lastFriday = debugData.lastFriday;
            const startTime = debugData.startTime;
            const endTime = debugData.endTime;
            
            document.getElementById('debugDate').textContent = lastFriday ? 
                new Date(lastFriday).toLocaleDateString('tr-TR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }) : '-';
            
            document.getElementById('debugStartTime').textContent = startTime ? 
                new Date(startTime).toLocaleString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                }) : '-';
            
            document.getElementById('debugEndTime').textContent = endTime ? 
                new Date(endTime).toLocaleString('tr-TR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                }) : '-';

            // BTC analysis
            const btc = debugData.btc;
            document.getElementById('debugCandleCount').textContent = btc.candleCount || '-';
            document.getElementById('debugWickHigh').textContent = btc.wickHigh ? 
                btc.wickHigh.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
            document.getElementById('debugWickLow').textContent = btc.wickLow ? 
                btc.wickLow.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
            document.getElementById('debugFib50').textContent = btc.fib50 ? 
                btc.fib50.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
            document.getElementById('debugCurrentPrice').textContent = btc.currentPrice ? 
                btc.currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
            document.getElementById('debugDistance').textContent = btc.distance !== undefined ? 
                btc.distance.toFixed(2) : '-';

            // Statistics
            const stats = debugData.stats;
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('stat1').textContent = stats.within1;
            document.getElementById('stat2').textContent = stats.within2;
            document.getElementById('stat5').textContent = stats.within5;
            document.getElementById('stat10').textContent = stats.within10;
        }

        function getLastFriday() {
            const now = new Date();
            const dayOfWeek = now.getUTCDay();
            const daysToSubtract = dayOfWeek >= 5 ? dayOfWeek - 5 : dayOfWeek + 2;
            const lastFriday = new Date(now);
            lastFriday.setUTCDate(now.getUTCDate() - daysToSubtract);
            lastFriday.setUTCHours(0, 0, 0, 0);
            
            console.log('üóìÔ∏è Last Friday:', lastFriday.toISOString());
            debugData.lastFriday = lastFriday.toISOString();
            
            return lastFriday;
        }

        function getAsianSessionTimes(date) {
            const startTime = new Date(date);
            startTime.setUTCHours(0, 0, 0, 0);
            
            const endTime = new Date(date);
            endTime.setUTCHours(8, 0, 0, 0);
            
            console.log('‚è∞ Asian Session Start:', startTime.toISOString());
            console.log('‚è∞ Asian Session End:', endTime.toISOString());
            
            debugData.startTime = startTime.toISOString();
            debugData.endTime = endTime.toISOString();
            
            return { startTime: startTime.getTime(), endTime: endTime.getTime() };
        }

        async function getKlines(symbol, startTime, endTime) {
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=15m&startTime=${startTime}&endTime=${endTime}`;
            const response = await fetch(url);
            return await response.json();
        }

        async function getCurrentPrice(symbol) {
            const url = `https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`;
            const response = await fetch(url);
            const data = await response.json();
            return parseFloat(data.price);
        }

        async function calculateFib50(symbol, startTime, endTime) {
            try {
                const klines = await getKlines(symbol, startTime, endTime);
                
                if (!klines || klines.length === 0) {
                    console.warn(`‚ö†Ô∏è No klines data for ${symbol}`);
                    return null;
                }

                let wickHigh = -Infinity;
                let wickLow = Infinity;

                klines.forEach(candle => {
                    const high = parseFloat(candle[2]);
                    const low = parseFloat(candle[3]);
                    
                    if (high > wickHigh) wickHigh = high;
                    if (low < wickLow) wickLow = low;
                });

                const fib50 = (wickHigh + wickLow) / 2;
                
                // Log BTC detailed calculation
                if (symbol === 'BTCUSDT') {
                    console.log('üìä BTC/USDT Detailed Calculation:');
                    console.log('  - Candle Count:', klines.length);
                    console.log('  - WickHigh:', wickHigh.toFixed(2));
                    console.log('  - WickLow:', wickLow.toFixed(2));
                    console.log('  - Fib50:', fib50.toFixed(2));
                    
                    debugData.btc = {
                        candleCount: klines.length,
                        wickHigh: wickHigh,
                        wickLow: wickLow,
                        fib50: fib50
                    };
                }

                return { fib50, wickHigh, wickLow };
            } catch (error) {
                console.error(`Error calculating Fib50 for ${symbol}:`, error);
                return null;
            }
        }

        async function scanMarkets() {
            const tolerance = parseFloat(document.getElementById('tolerance').value);
            const scanBtn = document.getElementById('scanBtn');
            
            scanBtn.disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('debugSection').style.display = 'none';

            // Reset stats
            debugData.stats = {
                total: 0,
                within1: 0,
                within2: 0,
                within5: 0,
                within10: 0
            };

            try {
                const lastFriday = getLastFriday();
                const { startTime, endTime } = getAsianSessionTimes(lastFriday);

                const response = await fetch('https://api.binance.com/api/v3/exchangeInfo');
                const data = await response.json();
                
                const usdtPairs = data.symbols
                    .filter(s => s.symbol.endsWith('USDT') && s.status === 'TRADING')
                    .map(s => s.symbol);

                console.log(`üìä Scanning ${usdtPairs.length} pairs...`);

                const results = [];

                for (const symbol of usdtPairs) {
                    const fibData = await calculateFib50(symbol, startTime, endTime);
                    
                    if (fibData) {
                        const currentPrice = await getCurrentPrice(symbol);
                        const distance = Math.abs(((currentPrice - fibData.fib50) / fibData.fib50) * 100);

                        // Log current price for BTC
                        if (symbol === 'BTCUSDT') {
                            console.log('  - Current Price:', currentPrice.toFixed(2));
                            console.log('  - Distance:', distance.toFixed(2) + '%');
                            debugData.btc.currentPrice = currentPrice;
                            debugData.btc.distance = distance;
                        }

                        debugData.stats.total++;
                        
                        if (distance <= 1) debugData.stats.within1++;
                        if (distance <= 2) debugData.stats.within2++;
                        if (distance <= 5) debugData.stats.within5++;
                        if (distance <= 10) debugData.stats.within10++;

                        if (distance <= tolerance) {
                            results.push({
                                symbol,
                                fib50: fibData.fib50,
                                currentPrice,
                                distance,
                                wickHigh: fibData.wickHigh,
                                wickLow: fibData.wickLow
                            });
                        }
                    }

                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                results.sort((a, b) => a.distance - b.distance);

                displayResults(results, tolerance);
                updateDebugPanel();

            } catch (error) {
                document.getElementById('resultsContent').innerHTML = 
                    `<div class="error">Hata olu≈ütu: ${error.message}</div>`;
                document.getElementById('results').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                scanBtn.disabled = false;
            }
        }

        function displayResults(results, tolerance) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('resultsContent');

            if (results.length === 0) {
                contentDiv.innerHTML = `<p>%${tolerance} tolerans i√ßinde sonu√ß bulunamadƒ±.</p>`;
            } else {
                let html = `
                    <p><strong>${results.length}</strong> coin %${tolerance} tolerans i√ßinde bulundu.</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Coin</th>
                                <th>Fib50</th>
                                <th>G√ºncel Fiyat</th>
                                <th>Mesafe</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                results.forEach(result => {
                    let distanceClass = 'distance-red';
                    if (result.distance <= 1) distanceClass = 'distance-green';
                    else if (result.distance <= 2) distanceClass = 'distance-yellow';
                    else if (result.distance <= 5) distanceClass = 'distance-orange';

                    html += `
                        <tr>
                            <td><strong>${result.symbol}</strong></td>
                            <td class="price">$${result.fib50.toFixed(8)}</td>
                            <td class="price">$${result.currentPrice.toFixed(8)}</td>
                            <td><span class="distance ${distanceClass}">%${result.distance.toFixed(2)}</span></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                contentDiv.innerHTML = html;
            }

            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>