<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asian Range Scanner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #controls {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #results {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Asian Range Scanner</h1>
    
    <div id="controls">
        <button id="scanBtn" onclick="startScan()">Start Scan</button>
        <div id="status"></div>
    </div>

    <div id="results">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Asian Range High</th>
                    <th>Asian Range Low</th>
                    <th>Fib 50%</th>
                    <th>Current Price</th>
                    <th>Distance to Fib50 (%)</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
        </table>
    </div>

    <script>
        const BINANCE_API = 'https://api.binance.com';
        
        function getAsianSessionTimeRange() {
            const now = new Date();
            
            // Find last Friday in UTC
            const utcDay = now.getUTCDay();
            const daysToSubtract = utcDay >= 5 ? utcDay - 5 : utcDay + 2;
            const lastFriday = new Date(now);
            lastFriday.setUTCDate(now.getUTCDate() - daysToSubtract);
            
            // Friday 19:00 NY (UTC-5) = Saturday 00:00 UTC
            const startTime = new Date(lastFriday);
            startTime.setUTCDate(lastFriday.getUTCDate() + 1);
            startTime.setUTCHours(0, 0, 0, 0);
            
            // Friday 23:59 NY (UTC-5) = Saturday 04:59 UTC
            const endTime = new Date(lastFriday);
            endTime.setUTCDate(lastFriday.getUTCDate() + 1);
            endTime.setUTCHours(4, 59, 59, 999);
            
            return { 
                startTime: startTime.getTime(), 
                endTime: endTime.getTime(),
                startDate: startTime,
                endDate: endTime
            };
        }

        async function getUSDTSymbols() {
            try {
                const response = await fetch(`${BINANCE_API}/api/v3/exchangeInfo`);
                const data = await response.json();
                return data.symbols
                    .filter(s => s.symbol.endsWith('USDT') && s.status === 'TRADING')
                    .map(s => s.symbol);
            } catch (error) {
                console.error('Error fetching symbols:', error);
                return [];
            }
        }

        async function getKlines(symbol, startTime, endTime) {
            try {
                const response = await fetch(
                    `${BINANCE_API}/api/v3/klines?symbol=${symbol}&interval=5m&startTime=${startTime}&endTime=${endTime}&limit=1000`
                );
                return await response.json();
            } catch (error) {
                console.error(`Error fetching klines for ${symbol}:`, error);
                return null;
            }
        }

        async function getCurrentPrice(symbol) {
            try {
                const response = await fetch(`${BINANCE_API}/api/v3/ticker/price?symbol=${symbol}`);
                const data = await response.json();
                return parseFloat(data.price);
            } catch (error) {
                console.error(`Error fetching current price for ${symbol}:`, error);
                return null;
            }
        }

        async function scanMarket() {
            const { startTime, endTime, startDate, endDate } = getAsianSessionTimeRange();
            
            console.log('Scanning Asian Session:', {
                start: startDate.toISOString(),
                end: endDate.toISOString()
            });

            const symbols = await getUSDTSymbols();
            const results = [];

            for (const symbol of symbols) {
                const klines = await getKlines(symbol, startTime, endTime);
                
                if (!klines || klines.length === 0) continue;

                // Calculate Asian Range using wick highs and lows
                let ar_wickHigh = -Infinity;
                let ar_wickLow = Infinity;

                for (const candle of klines) {
                    const high = parseFloat(candle[2]);
                    const low = parseFloat(candle[3]);
                    
                    if (high > ar_wickHigh) ar_wickHigh = high;
                    if (low < ar_wickLow) ar_wickLow = low;
                }

                const fib50 = (ar_wickHigh + ar_wickLow) / 2;
                const currentPrice = await getCurrentPrice(symbol);

                // Add debug logging for SAGA/USDT
                if (symbol === 'SAGAUSDT') {
                    console.log('=== SAGA DEBUG ===');
                    console.log('Start:', new Date(startTime).toISOString());
                    console.log('End:', new Date(endTime).toISOString());
                    console.log('Candles:', klines.length);
                    console.log('First Candle Time:', new Date(klines[0][0]).toISOString());
                    console.log('Last Candle Time:', new Date(klines[klines.length-1][0]).toISOString());
                    console.log('AR Wick High:', ar_wickHigh.toFixed(8));
                    console.log('AR Wick Low:', ar_wickLow.toFixed(8));
                    console.log('Fib50:', fib50.toFixed(8));
                    console.log('Expected:', '0.0623');
                }

                if (currentPrice) {
                    const distancePercent = ((currentPrice - fib50) / fib50) * 100;
                    
                    results.push({
                        symbol,
                        ar_wickHigh,
                        ar_wickLow,
                        fib50,
                        currentPrice,
                        distancePercent
                    });
                }

                // Rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            return results.sort((a, b) => Math.abs(a.distancePercent) - Math.abs(b.distancePercent));
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            results.forEach(result => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = result.symbol;
                row.insertCell(1).textContent = result.ar_wickHigh.toFixed(8);
                row.insertCell(2).textContent = result.ar_wickLow.toFixed(8);
                row.insertCell(3).textContent = result.fib50.toFixed(8);
                row.insertCell(4).textContent = result.currentPrice.toFixed(8);
                row.insertCell(5).textContent = result.distancePercent.toFixed(2) + '%';
            });
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function startScan() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            showStatus('Scanning market...', 'loading');

            try {
                const results = await scanMarket();
                displayResults(results);
                showStatus(`Scan complete! Found ${results.length} symbols.`, 'success');
            } catch (error) {
                console.error('Scan error:', error);
                showStatus('Error during scan. Check console for details.', 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>